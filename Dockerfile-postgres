FROM postgres:16
# Document https://pgroonga.github.io/install/debian.html

# 设置超级用户密码
ENV POSTGRES_PASSWORD=mysecretpassword

# 安装必要的工具和依赖
RUN apt-get update && apt-get install -y \
    ca-certificates \
    lsb-release \
    wget \
    gnupg \
    build-essential \
    pkg-config \
    zlib1g-dev \
    libmsgpack-dev \
    libzmq3-dev \
    libevent-dev \
    libmecab-dev \
    liblz4-dev \
    && rm -rf /var/lib/apt/lists/*

# 添加 Apache Arrow 和 Groonga 的 APT 源 并安装 Groonga
RUN wget https://apache.jfrog.io/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb && \
    apt-get install -y ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb && \
    wget https://packages.groonga.org/debian/groonga-apt-source-latest-$(lsb_release --codename --short).deb && \
    apt-get install -y ./groonga-apt-source-latest-$(lsb_release --codename --short).deb

# 复制数据库初始化脚本
COPY dbsetup.sql /docker-entrypoint-initdb.d/

# 初始化数据库和扩展
RUN docker-entrypoint.sh postgres & sleep 10 && \
    psql -U postgres -c "CREATE DATABASE luoxu_db;" && \
    psql -U postgres -d luoxu_db -c "CREATE EXTENSION pgroonga;" && \
    psql -U postgres -d luoxu_db -f /docker-entrypoint-initdb.d/dbsetup.sql
FROM postgres:16

# 安装 curl 和 gnupg，用于处理 GPG 密钥
RUN apt-get update && apt-get install -y curl gnupg

# 添加 pgroonga 官方软件包源
RUN echo "deb http://packages.groonga.org/debian/ bookworm main" > /etc/apt/sources.list.d/groonga.list && \
    curl -fsSL https://packages.groonga.org/debian/groonga-keyring.gpg | gpg --dearmor -o /usr/share/keyrings/groonga-keyring.gpg


# 安装 pgroonga
RUN apt-get update && \
    apt-get install -y pgroonga && \
    rm -rf /var/lib/apt/lists/*

# 复制数据库初始化脚本
COPY dbsetup.sql /docker-entrypoint-initdb.d/

# 初始化数据库和扩展
RUN docker-entrypoint.sh postgres & sleep 10 && \
    psql -U postgres -c "CREATE DATABASE luoxu_db;" && \
    psql -U postgres -d luoxu_db -c "CREATE EXTENSION pgroonga;" && \
    psql -U postgres -d luoxu_db -f /docker-entrypoint-initdb.d/dbsetup.sql
